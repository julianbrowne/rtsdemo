<html>
<head>
    <title>Bar Chart | RTS Demo</title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <link rel="stylesheet" href="/stylesheets/graph.css" />
    <script src='javascripts/d3.v2.min.js'></script>
    <script src='/socket.io/socket.io.js'></script>
    <script>
            var chartData   = [];
            var chartLabels = [];

            var socket = io.connect('/');

            socket.on('stats-channel', function (data) {
                var event = data.event;
                var count = data.count;
                console.log('Received new count of ' + count + ' for event ' + event);

                if(chartLabels.indexOf(event) != -1)
                    chartData[chartLabels.indexOf(event)] = chartData[chartLabels.indexOf(event)] + count;
                else
                {
                    chartLabels.push(event);
                    chartData[chartLabels.indexOf(event)] = count;
                }

                console.log('Updated count for ' + event + ' to ' + chartData[chartLabels.indexOf(event)]);
                updateChart(chartData);
            });
    </script>
</head>
<body>
    <h1>Bar Chart</h1>
    <div id="barchart" class="gallery"></div>
    <script>

        // Initialise SVG

        var width = 1000;
        var height = 600;

        var chart = d3.select("#barchart").append("svg")
            .attr("class", "chart")
            .attr("width", width)
            .attr("height", 20 * chartData.length);

        var x = d3.scale.linear()
            .domain([0, d3.max(chartData)])
            .range([0, width]);

        function updateChart(data)
        {
            if(data.length === 0)
                return;

            // rescale the chart to cope with new values

            x = d3.scale.linear()
                .domain([0, d3.max(data)])
                .range([0, width]);

            // resize the SVG in case there are new bars

            d3.select("svg")
                .attr("height", 20 * data.length);

            // updating bars

            chart.selectAll("rect")
                .data(data)
                    .style("fill", "steelblue")
                    .attr("y", function(d, i) { return i * 20; })
                    .attr("height", 20)
                    .transition()
                        .duration(300)
                            .attr("width", x);

            // updating labels

            chart.selectAll("text")
                .data(data)
                    .text(function(d,i) { return chartLabels[i] + ' (' + d + ')' });

            // entering bars

            chart.selectAll("rect")
                .data(data)
                .enter()
                .append("rect")
                    .style("fill", "#FF0000")
                    .attr("y", function(d, i) { return i * 20; })
                    .attr("height", 20)
                        .transition()
                            .duration(300)
                            .attr("width", x);


            // entering labels

            chart.selectAll("text")
                .data(data)
                .enter()
                .append("text")
                    .attr("x", 20)
                    .attr("y", function(d, i) { return (i * 20) + 10; })
                    .attr("dx", -3) // padding-right
                    .attr("dy", ".35em") // vertical-align: middle
                    .attr("text-anchor", "start") // text-align: right
                    .text(function(d,i) { return chartLabels[i] + ' (' + d + ')' });
        }

    </script>
</body>
</html>